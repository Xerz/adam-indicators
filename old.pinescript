//@version=6
indicator("GPT", overlay=false)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// GLOBAL Â· LATCH STATE (Ğ•Ğ”Ğ˜ĞĞ¡Ğ¢Ğ’Ğ•ĞĞĞĞ• ĞĞ‘ĞªĞ¯Ğ’Ğ›Ğ•ĞĞ˜Ğ•)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var bool filtersAllowedLatched = false

var bool signalLatched = false
var int  signalDirLatched = 0   // 1 = long, -1 = short

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// TRADE SIGNAL Â· LATCH (Ğ¤Ğ˜ĞšĞ¡ĞĞ¦Ğ˜Ğ¯ Ğ’Ğ¥ĞĞ”Ğ)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var bool tradeSignalLatched = false
var int  tradeSignalDir     = 0   // 1 = long, -1 = short

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ENTRY PRICE Â· LATCH
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var float entryPriceLatched = na


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· ĞĞ¡ĞĞĞ’ĞĞ«Ğ•
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
src      = input.source(close, "Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº")
fastLen = input.int(14, "Ğ”Ğ»Ğ¸Ğ½Ğ° Fast RSI")

useBarClose = input.bool(true, "Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ ÑĞ²ĞµÑ‡Ğ¸")
confirm     = useBarClose ? barstate.isconfirmed : true

useFWZone = input.bool(
    false,
    "FW: Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ²Ñ…Ğ¾Ğ´ Ğ¾ĞºĞ¾Ğ»Ğ¾ 0"
)

fwZone = input.float(
    5.0,
    "FW Ğ·Ğ¾Ğ½Ğ° Ğ²Ğ¾ĞºÑ€ÑƒĞ³ 0",
    step = 0.1,
    minval = 0
)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ Ğ« Ğ¢Ğ Ğ•ĞĞ”Ğ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
useEMA200 = input.bool(true, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ EMA 200")
emaLen    = input.int(200, "Ğ”Ğ»Ğ¸Ğ½Ğ° EMA")

useADX    = input.bool(true, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ADX")
adxLen    = input.int(7, "Ğ”Ğ»Ğ¸Ğ½Ğ° ADX")
adxSmooth = input.int(14, "Ğ¡Ğ³Ğ»Ğ°Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ADX")
adxMin    = input.float(22, "ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ADX")

useATRRegime = input.bool(true, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ATR Ñ€ĞµĞ¶Ğ¸Ğ¼")
atrLen       = input.int(7, "Ğ”Ğ»Ğ¸Ğ½Ğ° ATR")
atrMaLen     = input.int(50, "ATR MA Ğ´Ğ»Ğ¸Ğ½Ğ°")


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
useImpulseFilter = input.bool(true, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ½Ñ‹Ğµ ÑĞ²ĞµÑ‡Ğ¸")
excludeImpulse   = input.bool(true, "Ğ˜ÑĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑ Ğ¸Ğ· Ğ½Ğ¾Ñ€Ğ¼Ñ‹")

impulseLookback  = input.int(20, "ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ½Ğ¾Ñ€Ğ¼Ñ‹ ÑĞ²ĞµÑ‡Ğ¸")
impulseMult      = input.float(1.3, "ĞœÑƒĞ»ÑŒÑ‚Ğ¸Ğ¿Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°")

impulseMode = input.string("MIN", "Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°", options=["EASY","MIN","MAX"])
maxFastWave = input.float(20, "ĞœĞ°ĞºÑ. Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Fast Momentum")

// ğŸ” ĞŸĞ•Ğ Ğ•ĞšĞ›Ğ®Ğ§ĞĞ¢Ğ•Ğ›Ğ¬ Ğ Ğ•Ğ–Ğ˜ĞœĞ Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡Ğ
impulseDetectMode = input.string(
     "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ",
     "ĞšĞ°Ğº Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑÑ‚ÑŒ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑ",
     options = ["ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ", "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ"]
)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· Ğ’Ğ˜Ğ—Ğ£ĞĞ›
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

showFastWave   = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Fast Momentum")
showImpulseBg  = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ğ½ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°")
showSignal     = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹")
showATRState   = input.bool(false, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ATR Ñ€ĞµĞ¶Ğ¸Ğ¼")
showDebug      = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ´ĞµĞ±Ğ°Ğ³ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸")
showEntryPrice = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ Ğ²Ñ…Ğ¾Ğ´Ğ°")

signalVisualMode = input.string(
    "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ",
    "ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²",
    options = ["ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ", "Ğ¡Ñ€Ğ°Ğ·Ñƒ"]
)


maxEntryLabels = input.int(200, "ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¼ĞµÑ‚Ğ¾Ğº Ñ†ĞµĞ½Ñ‹ Ğ²Ñ…Ğ¾Ğ´Ğ°", minval=10, maxval=1000)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ‘Ğ£Ğ¤Ğ•Ğ  ĞœĞ•Ğ¢ĞĞš Ğ¦Ğ•ĞĞ«
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var label[] entryLabels = array.new<label>()
f_addLabel(lbl) =>
    array.push(entryLabels, lbl)
    if array.size(entryLabels) > maxEntryLabels
        label.delete(array.shift(entryLabels))

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// MOMENTUM CORE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
fastRSI  = ta.rsi(src, fastLen)
fastWave = ta.ema(fastRSI - 50, 3)

aboveBase = fastWave > 0
belowBase = fastWave < 0

fastWaveRising  = fastWave > fastWave[1]
fastWaveFalling = fastWave < fastWave[1]

fastWaveAllowed = math.abs(fastWave) <= maxFastWave

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ Ğ« Ğ¢Ğ Ğ•ĞĞ”Ğ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ema200   = ta.ema(close, emaLen)
emaLong  = close > ema200
emaShort = close < ema200

[_, _, adx] = ta.dmi(adxLen, adxSmooth)
adxTrend = adx > adxMin

atr      = ta.atr(atrLen)
atrMA    = ta.ema(atr, atrMaLen)
atrTrend = atr > atrMA

trendLongAllowed = (not useEMA200 or emaLong) and (not useADX or adxTrend) and (not useATRRegime or atrTrend)

trendShortAllowed = (not useEMA200 or emaShort) and (not useADX or adxTrend) and (not useATRRegime or atrTrend)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡ Â· ĞĞĞ ĞœĞ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
candleSizePct = math.abs((close - open) / open) * 100
preNormal     = ta.sma(candleSizePct, impulseLookback)

impulseRaw = useImpulseFilter and candleSizePct > preNormal * impulseMult

filteredSize = excludeImpulse and impulseRaw ? na : candleSizePct

normalSize = ta.sma(filteredSize[1], impulseLookback)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡ Â· Ğ¦Ğ•Ğ›Ğ˜
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
impulseTargetPct = normalSize * impulseMult
priceUp   = open * (1 + impulseTargetPct / 100)
priceDown = open * (1 - impulseTargetPct / 100)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PATCH 2 Â· Ğ¤Ğ˜ĞšĞ¡ĞĞ¦Ğ˜Ğ¯ ĞšĞĞ¡ĞĞĞ˜Ğ¯ Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡ĞĞĞ™ Ğ¦Ğ•ĞĞ«
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if impulseDetectMode == "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ" and
   filtersAllowedLatched and
   not signalLatched

    if high >= priceUp
        signalLatched := true
        signalDirLatched := 1
    else if low <= priceDown
        signalLatched := true
        signalDirLatched := -1

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡ Â· Ğ‘ĞĞ—ĞĞ’Ğ«Ğ• Ğ£Ğ¡Ğ›ĞĞ’Ğ˜Ğ¯ (Ğ‘ĞĞ—Ğ)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
impulseByCloseUp   = impulseRaw and close > open
impulseByCloseDown = impulseRaw and close < open

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PATCH 3 Â· Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡ Â· Ğ›ĞĞ“Ğ˜ĞšĞ Ğ¡ LATCH
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
impulseUp =
     impulseDetectMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ"
     ? impulseByCloseUp
     : signalLatched and signalDirLatched == 1

impulseDown =
     impulseDetectMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ"
     ? impulseByCloseDown
     : signalLatched and signalDirLatched == -1

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// TRADE SIGNAL + ENTRY PRICE Â· LATCH (Ğ Ğ•Ğ–Ğ˜Ğœ "Ğ¡Ğ ĞĞ—Ğ£")
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if signalVisualMode == "Ğ¡Ñ€Ğ°Ğ·Ñƒ"
    if not tradeSignalLatched
        if impulseUp and trendLongAllowed
            tradeSignalLatched := true
            tradeSignalDir := 1
            entryPriceLatched := priceUp
        else if impulseDown and trendShortAllowed
            tradeSignalLatched := true
            tradeSignalDir := -1
            entryPriceLatched := priceDown


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ Ğ•Ğ–Ğ˜ĞœĞ« ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ–Ğ”Ğ•ĞĞ˜Ğ¯
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
confirmEASY_Long  = true
confirmEASY_Short = true

confirmMIN_Long   = aboveBase
confirmMIN_Short  = belowBase

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FW Â· Ğ”ĞĞŸĞ£Ğ¡Ğš Ğ’ĞĞšĞ Ğ£Ğ“ 0 (Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ”Ğ›Ğ¯ MAX)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
fwLongAllowed =
     useFWZone
     ? fastWave > -fwZone
     : fastWave > 0

fwShortAllowed =
     useFWZone
     ? fastWave < fwZone
     : fastWave < 0

confirmMAX_Long =
     fwLongAllowed and fastWaveRising

confirmMAX_Short =
     fwShortAllowed and fastWaveFalling


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ«
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
longSignal = confirm and impulseUp and trendLongAllowed and (impulseMode=="EASY"?confirmEASY_Long:
     impulseMode=="MIN" ?(confirmMIN_Long and fastWaveAllowed):
                          (confirmMAX_Long and fastWaveAllowed))

shortSignal = confirm and impulseDown and trendShortAllowed and (impulseMode=="EASY"?confirmEASY_Short:
     impulseMode=="MIN" ?(confirmMIN_Short and fastWaveAllowed):
                          (confirmMAX_Short and fastWaveAllowed))

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// VISUAL SIGNAL SELECTOR
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
visualLongSignal =
     signalVisualMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ"
     ? longSignal
     : longSignal or (tradeSignalLatched and tradeSignalDir == 1)

visualShortSignal =
     signalVisualMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ"
     ? shortSignal
     : shortSignal or (tradeSignalLatched and tradeSignalDir == -1)


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ENTRY PRICE Â· FINAL GUARANTEE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if visualLongSignal and na(entryPriceLatched)
    entryPriceLatched := priceUp

if visualShortSignal and na(entryPriceLatched)
    entryPriceLatched := priceDown


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ENTRY PRICE Â· FALLBACK LATCH
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if signalVisualMode == "Ğ¡Ñ€Ğ°Ğ·Ñƒ"
    if visualLongSignal and na(entryPriceLatched)
        entryPriceLatched := close
    else if visualShortSignal and na(entryPriceLatched)
        entryPriceLatched := close

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ‘Ğ›ĞĞšĞ˜Ğ ĞĞ’ĞšĞ˜ (DEBUG)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
blockEMA_S  = useEMA200 and impulseDown and close > ema200
blockADX_S  = useADX and impulseDown and adx <= adxMin
blockATR_S  = useATRRegime and impulseDown and not atrTrend
blockFMW_S  = impulseMode!="EASY" and impulseDown and not fastWaveAllowed
blockWAIT_S = impulseDown and not confirm

blockEMA_L  = useEMA200 and impulseUp and close < ema200
blockADX_L  = useADX and impulseUp and adx <= adxMin
blockATR_L  = useATRRegime and impulseUp and not atrTrend
blockFMW_L  = impulseMode!="EASY" and impulseUp and not fastWaveAllowed
blockWAIT_L = impulseUp and not confirm

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// EARLY BLOCK Â· LATCH (Ğ¤Ğ˜ĞšĞ¡ ĞĞ ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ˜Ğ˜ Ğ¡Ğ’Ğ•Ğ§Ğ˜)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var bool earlyBlockLatched = false
var string earlyBlockReasonLatched = ""

if barstate.isnew
    earlyBlockLatched := false
    earlyBlockReasonLatched := ""

    if useEMA200 and ((emaLong == false and emaShort == false))
        earlyBlockLatched := true
        earlyBlockReasonLatched := "EMA"
    else if useADX and not adxTrend
        earlyBlockLatched := true
        earlyBlockReasonLatched := "ADX"
    else if useATRRegime and not atrTrend
        earlyBlockLatched := true
        earlyBlockReasonLatched := "ATR"
    else if impulseMode != "EASY" and not fastWaveAllowed
        earlyBlockLatched := true
        earlyBlockReasonLatched := "FMW"

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// LATCH Â· Ğ”ĞĞŸĞ£Ğ¡Ğš Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ ĞĞ Ğ¡Ğ’Ğ•Ğ§Ğ•
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if barstate.isnew
    filtersAllowedLatched := not earlyBlockLatched

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// PATCH 2 Â· Ğ¡Ğ‘Ğ ĞĞ¡ Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ ĞĞ ĞĞĞ’ĞĞ™ Ğ¡Ğ’Ğ•Ğ§Ğ•
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if barstate.isnew
    signalLatched := false
    signalDirLatched := 0
    tradeSignalLatched := false
    tradeSignalDir     := 0


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ ĞĞĞĞ¯Ğ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ£Ğ¡Ğ›ĞĞ’Ğ˜Ğ™ (LATCH)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
earlyBlockActive = earlyBlockLatched
earlyBlockReason = earlyBlockReasonLatched


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¦Ğ•ĞĞ Ğ’Ğ¥ĞĞ”Ğ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
entryPrice =
     not na(entryPriceLatched)
     ? entryPriceLatched
     : impulseUp   ? priceUp
     : impulseDown ? priceDown
     : na

if showEntryPrice and not na(entryPrice)
    if longSignal or shortSignal or
       (
         showDebug and
         (impulseUp or impulseDown) and
         not longSignal and not shortSignal
       )

        f_addLabel(label.new(
            bar_index, fastWave,
            "Ğ’Ğ¥ĞĞ”: " + str.tostring(entryPrice, format.mintick),
            style = longSignal?label.style_label_up:
                    shortSignal?label.style_label_down:
                    label.style_label_center,
            textcolor=color.white,
            color = longSignal?color.new(#0a440c,30):
                    shortSignal?color.new(#991919,30):
                    color.new(#63656d, 30),
            size=size.small))

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ’Ğ˜Ğ—Ğ£ĞĞ›
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
plot(showFastWave ? fastWave : na, "Fast Momentum", color=color.aqua, linewidth=2)
hline(0, "Ğ‘Ğ°Ğ·Ğ°", color=color.white)

bgcolor(showATRState and not atrTrend ? color.new(color.gray, 85) : na)


plotshape(showSignal and visualLongSignal,
     style=shape.triangleup,
     location=location.bottom,
     color=color.lime,
     size=size.small)

plotshape(showSignal and visualShortSignal,
     style=shape.triangledown,
     location=location.top,
     color=color.red,
     size=size.small)


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¤ĞĞ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞŸĞ Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ£
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
bgcolor(
     visualLongSignal  ? color.new(#0c6b0f, 85) :
     visualShortSignal ? color.new(#940d0d, 85) :
     na
)



//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// DEBUG Â· BLOCK REASONS (Ğ’Ğ¡Ğ¯ Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// SHORT
plotshape(showDebug and impulseDown and not shortSignal and blockEMA_S,
     text="EMA", style=shape.labeldown, location=location.top,
     color=color.new(color.red, 70), textcolor=color.white, size=size.small)

plotshape(showDebug and impulseDown and not shortSignal and
     not blockEMA_S and blockADX_S,
     text="ADX", style=shape.labeldown, location=location.top,
     color=color.new(color.red, 70), textcolor=color.white, size=size.small)

plotshape(showDebug and impulseDown and not shortSignal and
     not blockEMA_S and not blockADX_S and blockATR_S,
     text="ATR", style=shape.labeldown, location=location.top,
     color=color.new(color.red, 70), textcolor=color.white, size=size.small)

plotshape(showDebug and impulseDown and not shortSignal and
     not blockEMA_S and not blockADX_S and not blockATR_S and blockFMW_S,
     text="FMW", style=shape.labeldown, location=location.top,
     color=color.new(color.red, 70), textcolor=color.white, size=size.small)


// LONG
plotshape(showDebug and impulseUp and not longSignal and blockEMA_L,
     text="EMA", style=shape.labelup, location=location.bottom,
     color=color.new(color.green, 70), textcolor=color.white, size=size.small)

plotshape(showDebug and impulseUp and not longSignal and
     not blockEMA_L and blockADX_L,
     text="ADX", style=shape.labelup, location=location.bottom,
     color=color.new(color.green, 70), textcolor=color.white, size=size.small)

plotshape(showDebug and impulseUp and not longSignal and
     not blockEMA_L and not blockADX_L and blockATR_L,
     text="ATR", style=shape.labelup, location=location.bottom,
     color=color.new(color.green, 70), textcolor=color.white, size=size.small)

plotshape(showDebug and impulseUp and not longSignal and
     not blockEMA_L and not blockADX_L and not blockATR_L and blockFMW_L,
     text="FMW", style=shape.labelup, location=location.bottom,
     color=color.new(color.green, 70), textcolor=color.white, size=size.small)


//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// REALTIME PANEL Â· IMPULSE INFO (EXTENDED)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° (1 Ñ€Ğ°Ğ·)
var table rtPanel = table.new(position.top_right, 1, 3)

// Ğ·Ğ°Ñ‰Ñ‘Ğ»ĞºĞ° ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ° (1 Ñ€Ğ°Ğ· Ğ½Ğ° ÑĞ²ĞµÑ‡Ñƒ)
var bool impulseTouched = false

if barstate.isnew
    impulseTouched := false

// â”€â”€â”€â”€â”€ Ğ¾Ğ±ÑŠÑĞ²Ğ»ÑĞµĞ¼ Ğ’Ğ¡Ğ• Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ñ€Ğ°Ğ½ĞµĞµ â”€â”€â”€â”€â”€
var float impulsePct   = na
var float remainPct    = na
var float impulsePrice = na
var string sign        = ""
var color  remainColor = color.white

var string cellText = ""
var color  cellTextColor = color.white

// â”€â”€â”€â”€â”€ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ â”€â”€â”€â”€â”€
if barstate.islast and not na(normalSize)

    impulsePct := normalSize * impulseMult
    movePct    = (close - open) / open * 100

    isLongMove = movePct >= 0
    sign       := isLongMove ? "+" : "âˆ’"

    remainPct := math.max(impulsePct - math.abs(movePct), 0)

    impulsePrice :=
         isLongMove
         ? open * (1 + impulsePct / 100)
         : open * (1 - impulsePct / 100)

    // Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ°ÑĞ°Ğ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‹ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ° (1 Ñ€Ğ°Ğ·)
    if not impulseTouched
        if (isLongMove and high >= impulsePrice) or
           (not isLongMove and low <= impulsePrice)
            impulseTouched := true

    // Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ†Ğ²ĞµÑ‚ "Ğ”Ğ¾ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°"
    remainColor :=
         impulseTouched ? color.new(#d4af37, 0) :
         isLongMove     ? color.new(color.lime, 0) :
                          color.new(color.red, 0)

    // â”€â”€â”€â”€â”€ Ğ¤ĞĞ ĞœĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ• Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ Ğ¡ ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ĞĞœ "ĞĞ• Ğ’Ğ¥ĞĞ”Ğ˜Ğ¢Ğ¬" â”€â”€â”€â”€â”€
    if earlyBlockLatched
        cellText := "ĞĞµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ (" + earlyBlockReasonLatched + ")"
        cellTextColor := color.red
    else
        cellText := "Ğ”Ğ¾ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°:\n" + sign + str.tostring(remainPct, "#.###") + "% (" + str.tostring(impulsePrice, format.mintick) + ")"
        cellTextColor := remainColor

    // â”€â”€â”€â”€â”€ Ğ²Ñ‹Ğ²Ğ¾Ğ´ â”€â”€â”€â”€â”€
    table.cell(
        rtPanel, 0, 0,
        "ĞĞ¾Ñ€Ğ¼Ğ° ÑĞ²ĞµÑ‡Ğ¸:\n" +
        str.tostring(normalSize, "#.###") + "%",
        text_color = color.white,
        bgcolor = color.new(color.black, 70)
    )

    table.cell(
        rtPanel, 0, 1,
        "Ğ˜Ğ¼Ğ¿ÑƒĞ»ÑŒÑ ÑĞ²ĞµÑ‡Ğ¸:\n" +
        str.tostring(impulsePct, "#.###") + "%",
        text_color = color.white,
        bgcolor = color.new(color.black, 70)
    )

    table.cell(
        rtPanel, 0, 2,
        cellText,
        text_color = cellTextColor,
        bgcolor = color.new(color.black, 70)
    )


