//@version=6
indicator("MOMENTUM 2", overlay=false, max_labels_count=500)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¡Ğ‘Ğ ĞĞ¡ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ™ ĞŸĞ Ğ˜ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ˜ Ğ¢ĞĞ™ĞœĞ¤Ğ Ğ•Ğ™ĞœĞ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var string lastPeriod = ""
var bool resetTriggered = false

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞ‘ĞªĞ¯Ğ’Ğ›Ğ•ĞĞ˜Ğ• Ğ’Ğ¡Ğ•Ğ¥ VAR ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ¥
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var bool filtersAllowedFixed = false
var string filterBlockReasonFixed = ""

var bool emaLongFixed = false
var bool emaShortFixed = false
var bool adxTrendFixed = false
var bool atrTrendFixed = false
var float fastWaveFixed = na
var bool fastWaveRisingFixed = false
var bool fastWaveFallingFixed = false
var bool fastWaveAllowedFixed = false

var bool impulseTouched = false
var int  impulseDirection = 0  // 1 = up, -1 = down

var bool signalFinalized = false
var bool signalIsLong = false
var bool signalIsShort = false

var bool longSignalToPlot = false
var bool shortSignalToPlot = false

var bool debugEMAShapeS = false
var bool debugADXShapeS = false
var bool debugATRShapeS = false
var bool debugFMWShapeS = false
var bool debugEMAShapeL = false
var bool debugADXShapeL = false
var bool debugATRShapeL = false
var bool debugFMWShapeL = false

var bool signalTriggeredOnBar = false

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¡Ğ‘Ğ ĞĞ¡ ĞŸĞ Ğ˜ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ˜ Ğ¢ĞĞ™ĞœĞ¤Ğ Ğ•Ğ™ĞœĞ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
currentPeriod = timeframe.period

if currentPeriod != lastPeriod
    // Ğ¢Ğ°Ğ¹Ğ¼Ñ„Ñ€ĞµĞ¹Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ â€” ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑÑ‘
    lastPeriod := currentPeriod
    resetTriggered := true

    impulseTouched := false
    impulseDirection := 0
    signalFinalized := false
    signalIsLong := false
    signalIsShort := false
    filtersAllowedFixed := false
    filterBlockReasonFixed := ""
    emaLongFixed := false
    emaShortFixed := false
    adxTrendFixed := false
    atrTrendFixed := false
    fastWaveFixed := na
    fastWaveRisingFixed := false
    fastWaveFallingFixed := false
    fastWaveAllowedFixed := false
    signalTriggeredOnBar := false

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· Ğ˜Ğ¡Ğ¢ĞĞ§ĞĞ˜Ğš Ğ˜ ĞĞ¡ĞĞĞ’Ğ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
src      = input.source(close, "Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…")
fastLen  = input.int(14, "Ğ”Ğ»Ğ¸Ğ½Ğ° Fast RSI")
maxFastWave = input.float(20.0, "ĞœĞ°ĞºÑ. Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ÑƒĞ¼Ğ°", step=0.5, minval=5.0)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
impulseLookback  = input.int(20, "ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ½Ğ¾Ñ€Ğ¼Ñ‹ ÑĞ²ĞµÑ‡Ğ¸", minval=5)
impulseMult      = input.float(1.3, "ĞœÑƒĞ»ÑŒÑ‚Ğ¸Ğ¿Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°", step=0.1, minval=1.0)
excludeImpulse   = input.bool(true, "Ğ˜ÑĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑ Ğ¸Ğ· Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ½Ğ¾Ñ€Ğ¼Ñ‹")

impulseDetectMode = input.string(
     "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ",
     "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°",
     options = ["ĞŸĞ¾ Ñ†ĞµĞ½Ğµ", "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ", "LIVE"]
)

touchMode = input.string(
     "ĞŸĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ñ†ĞµĞ½Ğµ",
     "ĞšĞ°ÑĞ°Ğ½Ğ¸Ğµ Ñ†ĞµĞ»Ğ¸",
     options = ["ĞŸĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ñ†ĞµĞ½Ğµ", "ĞŸĞ¾ high/low"]
)

impulseMode = input.string("EASY", "Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ", options=["EASY", "MAX"])

// FW-Ğ·Ğ¾Ğ½Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° MAX)
useFWZone = input.bool(false, "Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ²Ñ…Ğ¾Ğ´ Ğ¾ĞºĞ¾Ğ»Ğ¾ Ğ½ÑƒĞ»Ñ (Ñ€ĞµĞ¶Ğ¸Ğ¼ MAX)")
fwZone    = input.float(5.0, "Ğ—Ğ¾Ğ½Ğ° Ğ²Ğ¾ĞºÑ€ÑƒĞ³ 0", step=0.1, minval=0)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ Ğ« Ğ¢Ğ Ğ•ĞĞ”Ğ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
useEMA200 = input.bool(true, "Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ EMA 200")
emaLen    = input.int(200, "Ğ”Ğ»Ğ¸Ğ½Ğ° EMA", minval=50)

useADX    = input.bool(true, "Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ ADX")
adxLen    = input.int(7, "Ğ”Ğ»Ğ¸Ğ½Ğ° ADX", minval=3)
adxSmooth = input.int(14, "Ğ¡Ğ³Ğ»Ğ°Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ADX", minval=5)
adxMin    = input.float(22.0, "ĞœĞ¸Ğ½. ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ADX", step=1, minval=10)

useATRRegime = input.bool(true, "Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ²Ğ¾Ğ»Ğ°Ñ‚Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ (ATR)")
atrLen   = input.int(7, "Ğ”Ğ»Ğ¸Ğ½Ğ° ATR", minval=3)
atrMaLen = input.int(50, "Ğ”Ğ»Ğ¸Ğ½Ğ° MA ATR", minval=10)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Â· Ğ’Ğ˜Ğ—Ğ£ĞĞ›
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
showFastWave  = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¸Ğ½Ğ¸Ñ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ÑƒĞ¼Ğ°")
showSignals   = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ‹")
showEntryPrice = input.bool(true, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ†ĞµĞ½Ñƒ Ğ²Ñ…Ğ¾Ğ´Ğ°")
showDebug     = input.bool(false, "ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ´ĞµĞ±Ğ°Ğ³ (Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸)")
maxEntryLabels = input.int(200, "ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¼ĞµÑ‚Ğ¾Ğº Ñ†ĞµĞ½Ñ‹ Ğ²Ñ…Ğ¾Ğ´Ğ°", minval=10, maxval=1000)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ‘Ğ£Ğ¤Ğ•Ğ  ĞœĞ•Ğ¢ĞĞš Ğ¦Ğ•ĞĞ« Ğ’Ğ¥ĞĞ”Ğ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var label[] entryLabels = array.new<label>()
f_addLabel(lbl) =>
    array.push(entryLabels, lbl)
    if array.size(entryLabels) > maxEntryLabels
        label.delete(array.shift(entryLabels))

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜ Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ ĞĞ’
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
f_trendAllowedLong(_emaLong, _adxTrend, _atrTrend) =>
    (not useEMA200 or _emaLong) and (not useADX or _adxTrend) and (not useATRRegime or _atrTrend)

f_trendAllowedShort(_emaShort, _adxTrend, _atrTrend) =>
    (not useEMA200 or _emaShort) and (not useADX or _adxTrend) and (not useATRRegime or _atrTrend)

f_momentumConfirmsLong(_fastWave, _fastWaveRising, _fastWaveAllowed) =>
    if impulseMode == "EASY"
        true
    else
        (useFWZone ? _fastWave > -fwZone : _fastWave > 0) and _fastWaveRising and _fastWaveAllowed

f_momentumConfirmsShort(_fastWave, _fastWaveFalling, _fastWaveAllowed) =>
    if impulseMode == "EASY"
        true
    else
        (useFWZone ? _fastWave < fwZone : _fastWave < 0) and _fastWaveFalling and _fastWaveAllowed

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// MOMENTUM CORE
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
fastRSI  = ta.rsi(src, fastLen)
fastWave = ta.ema(fastRSI - 50, 3)

aboveBase = fastWave > 0
belowBase = fastWave < 0

fastWaveRising  = fastWave > fastWave[1]
fastWaveFalling = fastWave < fastWave[1]

fastWaveAllowed = math.abs(fastWave) <= maxFastWave

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ Ğ« Ğ¢Ğ Ğ•ĞĞ”Ğ (Ğ¢Ğ•ĞšĞ£Ğ©Ğ•Ğ• Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ•)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ema200   = ta.ema(close, emaLen)
emaLong  = close > ema200
emaShort = close < ema200

[_, _, adx] = ta.dmi(adxLen, adxSmooth)
adxTrend = adx > adxMin

atr      = ta.atr(atrLen)
atrMA    = ta.ema(atr, atrMaLen)
atrTrend = atr > atrMA

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡ Â· ĞĞĞ ĞœĞ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¼ ÑĞ²ĞµÑ‡Ğ°Ğ¼)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¢Ğ•Ğ›Ğ ÑĞ²ĞµÑ‡Ğ¸ (close - open) Ğ´Ğ»Ñ ĞµĞ´Ğ¸Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ
currentBodyPct = math.abs(close - open) / open * 100

// Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ½Ğ¾Ñ€Ğ¼Ñ‹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ñ‚ĞµĞ» Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… ÑĞ²ĞµÑ‡ĞµĞ¹
preNormal = ta.sma(math.abs(close[1] - open[1]) / open[1] * 100, impulseLookback)

// ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ ÑĞ²ĞµÑ‡Ğ° Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ½Ğ¾Ğ¹ (Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)
impulseRaw = currentBodyPct > preNormal * impulseMult

// Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ½Ñ‹Ğµ ÑĞ²ĞµÑ‡Ğ¸ Ğ¸Ğ· Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ½Ğ¾Ñ€Ğ¼Ñ‹ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… ÑĞ²ĞµÑ‡ĞµĞ¹
filteredSize = excludeImpulse and impulseRaw ? na : currentBodyPct

// ĞĞ¾Ñ€Ğ¼Ğ° = ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 20 Ğ—ĞĞšĞ Ğ«Ğ¢Ğ«Ğ¥ ÑĞ²ĞµÑ‡ĞµĞ¹ (Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹)
normalSize = ta.sma(filteredSize[1], impulseLookback)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ˜ĞœĞŸĞ£Ğ›Ğ¬Ğ¡ Â· Ğ¦Ğ•Ğ›Ğ˜ (Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹ Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ ÑĞ²ĞµÑ‡Ğ¸)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ na Ğ² normalSize
safeNormalSize = na(normalSize) ? preNormal : normalSize
impulseTargetPct = safeNormalSize * impulseMult

priceUp   = open * (1 + impulseTargetPct / 100)
priceDown = open * (1 - impulseTargetPct / 100)

// ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ¸ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ Ñ†ĞµĞ»Ğ¸ (Ğ½Ğµ Ğ¼ĞµĞ½ÑŒÑˆĞµ 1 Ñ‚Ğ¸ĞºĞ°)
minTargetPct = open > 0 ? (syminfo.mintick / open) * 100 : na
targetValid = not na(impulseTargetPct) and not na(minTargetPct) and impulseTargetPct >= minTargetPct

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ—ĞĞ©ĞĞ›ĞšĞ˜ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ™ ĞĞ ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ˜Ğ˜ Ğ¡Ğ’Ğ•Ğ§Ğ˜
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if barstate.isnew
    // Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ²ÑĞµÑ… ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ğ½Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ²ĞµÑ‡Ğµ
    impulseTouched := false
    impulseDirection := 0
    signalFinalized := false
    signalIsLong := false
    signalIsShort := false
    signalTriggeredOnBar := false

    // Ğ¤Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² Ğ½Ğ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ ÑĞ²ĞµÑ‡Ğ¸
    emaLongFixed := close > ema200
    emaShortFixed := close < ema200
    adxTrendFixed := adx > adxMin
    atrTrendFixed := atr > atrMA
    fastWaveFixed := fastWave
    fastWaveRisingFixed := fastWave > fastWave[1]
    fastWaveFallingFixed := fastWave < fastWave[1]
    fastWaveAllowedFixed := math.abs(fastWave) <= maxFastWave

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ°ÑÑ‚ Ğ»Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ²Ñ…Ğ¾Ğ´ Ğ² Ğ›Ğ®Ğ‘ĞĞœ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
    longAllowedFixed = f_trendAllowedLong(emaLongFixed, adxTrendFixed, atrTrendFixed)
    shortAllowedFixed = f_trendAllowedShort(emaShortFixed, adxTrendFixed, atrTrendFixed)

    if longAllowedFixed or shortAllowedFixed
        filtersAllowedFixed := true
        filterBlockReasonFixed := ""
    else
        filtersAllowedFixed := false
        if useEMA200 and not emaLongFixed and not emaShortFixed
            filterBlockReasonFixed := "EMA"
        else if useADX and not adxTrendFixed
            filterBlockReasonFixed := "ADX"
        else if useATRRegime and not atrTrendFixed
            filterBlockReasonFixed := "ATR"
        else if impulseMode != "EASY" and not fastWaveAllowedFixed
            filterBlockReasonFixed := "FMW"

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ĞšĞĞ¡ĞĞĞ˜Ğ¯ Ğ¦Ğ•ĞĞ« Ğ¦Ğ•Ğ›Ğ˜ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ½Ğ¾ ĞºĞ°ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğ° ÑĞ²ĞµÑ‡Ñƒ)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if not signalTriggeredOnBar and impulseDetectMode != "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" and targetValid
    touchUp = touchMode == "ĞŸĞ¾ high/low" ? high >= priceUp : close >= priceUp
    touchDown = touchMode == "ĞŸĞ¾ high/low" ? low <= priceDown : close <= priceDown
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²ĞµÑ€Ñ…Ğ½ÑÑ Ñ†ĞµĞ»ÑŒ (ĞºĞ°ÑĞ°Ğ½Ğ¸Ğµ Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ)
    if touchUp
        impulseTouched := true
        impulseDirection := 1
        signalTriggeredOnBar := true  // ğŸ”’ Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ Ğ½Ğ° ÑÑ‚Ğ¾Ğ¹ ÑĞ²ĞµÑ‡Ğµ
    else if touchDown
        impulseTouched := true
        impulseDirection := -1
        signalTriggeredOnBar := true  // ğŸ”’ Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¤Ğ˜ĞĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ (Ñ„Ğ¸ĞºÑĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if not signalFinalized
    signalCondition = false
    isLong = false
    isShort = false

    // â”€â”€â”€â”€â”€ Ğ Ğ•Ğ–Ğ˜Ğœ "ĞŸĞ Ğ¦Ğ•ĞĞ•" â”€â”€â”€â”€â”€
    if impulseDetectMode == "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ" and impulseTouched
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        momentumOKLong = f_momentumConfirmsLong(fastWaveFixed, fastWaveRisingFixed, fastWaveAllowedFixed)
        momentumOKShort = f_momentumConfirmsShort(fastWaveFixed, fastWaveFallingFixed, fastWaveAllowedFixed)

        if impulseDirection == 1
            longAllowed = f_trendAllowedLong(emaLongFixed, adxTrendFixed, atrTrendFixed)
            signalCondition := filtersAllowedFixed and longAllowed and momentumOKLong
            isLong := true
        else if impulseDirection == -1
            shortAllowed = f_trendAllowedShort(emaShortFixed, adxTrendFixed, atrTrendFixed)
            signalCondition := filtersAllowedFixed and shortAllowed and momentumOKShort
            isShort := true

    // â”€â”€â”€â”€â”€ Ğ Ğ•Ğ–Ğ˜Ğœ LIVE â”€â”€â”€â”€â”€
    else if impulseDetectMode == "LIVE" and impulseTouched
        // Ğ’ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¢Ğ•ĞšĞ£Ğ©Ğ•Ğ• ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
        momentumOKLong = f_momentumConfirmsLong(fastWave, fastWaveRising, fastWaveAllowed)
        momentumOKShort = f_momentumConfirmsShort(fastWave, fastWaveFalling, fastWaveAllowed)

        if impulseDirection == 1
            longAllowed = f_trendAllowedLong(emaLong, adxTrend, atrTrend)
            signalCondition := longAllowed and momentumOKLong
            isLong := true
        else if impulseDirection == -1
            shortAllowed = f_trendAllowedShort(emaShort, adxTrend, atrTrend)
            signalCondition := shortAllowed and momentumOKShort
            isShort := true

    // â”€â”€â”€â”€â”€ Ğ Ğ•Ğ–Ğ˜Ğœ "ĞŸĞ Ğ—ĞĞšĞ Ğ«Ğ¢Ğ˜Ğ®" â”€â”€â”€â”€â”€
    else if impulseDetectMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" and barstate.isconfirmed
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
        momentumOKLong = f_momentumConfirmsLong(fastWaveFixed, fastWaveRisingFixed, fastWaveAllowedFixed)
        momentumOKShort = f_momentumConfirmsShort(fastWaveFixed, fastWaveFallingFixed, fastWaveAllowedFixed)

        impulseByCloseUp = impulseRaw and close > open
        impulseByCloseDown = impulseRaw and close < open

        if impulseByCloseUp
            longAllowed = f_trendAllowedLong(emaLongFixed, adxTrendFixed, atrTrendFixed)
            signalCondition := impulseRaw and filtersAllowedFixed and longAllowed and momentumOKLong
            isLong := true
        else if impulseByCloseDown
            shortAllowed = f_trendAllowedShort(emaShortFixed, adxTrendFixed, atrTrendFixed)
            signalCondition := impulseRaw and filtersAllowedFixed and shortAllowed and momentumOKShort
            isShort := true

    // Ğ¤Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµĞ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ»
    if signalCondition
        signalFinalized := true
        signalIsLong := isLong
        signalIsShort := isShort

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¦Ğ•ĞĞ Ğ’Ğ¥ĞĞ”Ğ (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ»Ñ "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ")
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var float entryPrice = na

// Ğ”Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ² "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ" Ğ¸ "LIVE" â€” Ñ†ĞµĞ½Ğ° Ğ¸Ğ· ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ
if (impulseDetectMode == "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ" or impulseDetectMode == "LIVE") and impulseTouched
    entryPrice := impulseDirection == 1 ? priceUp : priceDown

// Ğ”Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" â€” Ñ†ĞµĞ½Ğ° Ñ†ĞµĞ»Ğ¸, Ğ¿Ñ€Ğ¸ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ ÑĞ²ĞµÑ‡Ğ° ÑÑ‚Ğ°Ğ»Ğ° Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ½Ğ¾Ğ¹
if impulseDetectMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" and signalFinalized and (signalIsLong or signalIsShort)
    if signalIsLong
        entryPrice := priceUp
    else if signalIsShort
        entryPrice := priceDown

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ’Ğ˜Ğ—Ğ£ĞĞ› Â· ĞœĞ•Ğ¢ĞšĞ˜ Ğ¦Ğ•ĞĞ« Ğ’Ğ¥ĞĞ”Ğ Ğ˜ Ğ”Ğ•Ğ‘ĞĞ“
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Ğ”ĞµĞ±Ğ°Ğ³-Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸ (Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ¸ Ğ½ĞµÑ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ°)
blockEMA_L = useEMA200 and impulseTouched and impulseDirection == 1 and close < ema200
blockADX_L = useADX and impulseTouched and impulseDirection == 1 and adx <= adxMin
blockATR_L = useATRRegime and impulseTouched and impulseDirection == 1 and not atrTrend
blockFMW_L = impulseMode != "EASY" and impulseTouched and impulseDirection == 1 and not fastWaveAllowed

blockEMA_S = useEMA200 and impulseTouched and impulseDirection == -1 and close > ema200
blockADX_S = useADX and impulseTouched and impulseDirection == -1 and adx <= adxMin
blockATR_S = useATRRegime and impulseTouched and impulseDirection == -1 and not atrTrend
blockFMW_S = impulseMode != "EASY" and impulseTouched and impulseDirection == -1 and not fastWaveAllowed

// ĞœĞµÑ‚ĞºĞ¸ Ñ†ĞµĞ½Ñ‹ Ğ²Ñ…Ğ¾Ğ´Ğ°
if showEntryPrice and not na(entryPrice)
    shouldShowLabel = false
    labelStyle = label.style_label_center
    labelColor = color.new(#63656d, 30)  // ÑĞµÑ€Ñ‹Ğ¹ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ

    // Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
    if signalFinalized and (signalIsLong or signalIsShort)
        shouldShowLabel := true
        labelStyle := signalIsLong ? label.style_label_up : label.style_label_down
        labelColor := signalIsLong ? color.new(#0a440c, 30) : color.new(#991919, 30)

    // Ğ˜Ğ¼Ğ¿ÑƒĞ»ÑŒÑ Ğ±ĞµĞ· ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ° (Ğ´ĞµĞ±Ğ°Ğ³)
    else if showDebug and impulseTouched
        shouldShowLabel := true
        labelStyle := label.style_label_center
        labelColor := color.new(#63656d, 30)

    if shouldShowLabel
        f_addLabel(label.new(
             bar_index, fastWave,
             "Ğ’Ğ¥ĞĞ”: " + str.tostring(entryPrice, format.mintick),
             style = labelStyle,
             textcolor = color.white,
             color = labelColor,
             size = size.small))

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ’Ğ˜Ğ—Ğ£ĞĞ› Â· Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ« (Ğ¢Ğ Ğ•Ğ£Ğ“ĞĞ›Ğ¬ĞĞ˜ĞšĞ˜)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if barstate.isconfirmed
    longSignalToPlot := false
    shortSignalToPlot := false

if showSignals and showFastWave
    // Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ğ´Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ² "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ" Ğ¸ "LIVE" (Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ Ñ†ĞµĞ»Ğ¸)
    if impulseDetectMode != "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" and signalFinalized
        longSignalToPlot := signalIsLong
        shortSignalToPlot := signalIsShort

    // Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ‹ Ğ´Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ)
    else if impulseDetectMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" and barstate.isconfirmed and signalFinalized
        longSignalToPlot := signalIsLong
        shortSignalToPlot := signalIsShort

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ plotshape Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ (Ğ²Ğ½Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹)
plotshape(longSignalToPlot, style=shape.triangleup, location=location.bottom, color=color.lime, size=size.small, title="Long Signal")
plotshape(shortSignalToPlot, style=shape.triangledown, location=location.top, color=color.red, size=size.small, title="Short Signal")

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¡Ğ•Ğ Ğ˜Ğ˜ Ğ¡Ğ˜Ğ“ĞĞĞ›ĞĞ’ Ğ”Ğ›Ğ¯ Ğ¡Ğ¢Ğ ĞĞ¢Ğ•Ğ“Ğ˜Ğ™ (Ğ¡ĞšĞ Ğ«Ğ¢Ğ«Ğ• PLOT)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
longSignalSeries = false
shortSignalSeries = false

if impulseDetectMode != "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" and signalFinalized
    longSignalSeries := signalIsLong
    shortSignalSeries := signalIsShort
else if impulseDetectMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ" and barstate.isconfirmed and signalFinalized
    longSignalSeries := signalIsLong
    shortSignalSeries := signalIsShort

plot(longSignalSeries ? 1 : 0, title="Long Signal (series)", display=display.none)
plot(shortSignalSeries ? -1 : 0, title="Short Signal (series)", display=display.none)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ’Ğ˜Ğ—Ğ£ĞĞ› Â· Ğ¤ĞĞ (Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²)
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
bgcolor(
     showSignals and (signalFinalized and signalIsLong) ? color.new(#0c6b0f, 85) :
     showSignals and (signalFinalized and signalIsShort) ? color.new(#940d0d, 85) :
     na
)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ’Ğ˜Ğ—Ğ£ĞĞ› Â· Ğ”Ğ•Ğ‘ĞĞ“ ĞœĞ•Ğ¢ĞšĞ˜ ĞŸĞ Ğ˜Ğ§Ğ˜Ğ Ğ‘Ğ›ĞĞšĞ˜Ğ ĞĞ’ĞšĞ˜
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if showDebug and showFastWave
    // SHORT Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸
    debugEMAShapeS := impulseTouched and impulseDirection == -1 and not signalFinalized and blockEMA_S
    debugADXShapeS := impulseTouched and impulseDirection == -1 and not signalFinalized and not blockEMA_S and blockADX_S
    debugATRShapeS := impulseTouched and impulseDirection == -1 and not signalFinalized and not blockEMA_S and not blockADX_S and blockATR_S
    debugFMWShapeS := impulseTouched and impulseDirection == -1 and not signalFinalized and not blockEMA_S and not blockADX_S and not blockATR_S and blockFMW_S

    // LONG Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸
    debugEMAShapeL := impulseTouched and impulseDirection == 1 and not signalFinalized and blockEMA_L
    debugADXShapeL := impulseTouched and impulseDirection == 1 and not signalFinalized and not blockEMA_L and blockADX_L
    debugATRShapeL := impulseTouched and impulseDirection == 1 and not signalFinalized and not blockEMA_L and not blockADX_L and blockATR_L
    debugFMWShapeL := impulseTouched and impulseDirection == 1 and not signalFinalized and not blockEMA_L and not blockADX_L and not blockATR_L and blockFMW_L

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ plotshape Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ´Ğ»Ñ Ğ´ĞµĞ±Ğ°Ğ³Ğ°
plotshape(debugEMAShapeS, text="EMA", style=shape.labeldown, location=location.top, color=color.new(color.red, 70), textcolor=color.white, size=size.small, title="Debug EMA Short")
plotshape(debugADXShapeS, text="ADX", style=shape.labeldown, location=location.top, color=color.new(color.red, 70), textcolor=color.white, size=size.small, title="Debug ADX Short")
plotshape(debugATRShapeS, text="ATR", style=shape.labeldown, location=location.top, color=color.new(color.red, 70), textcolor=color.white, size=size.small, title="Debug ATR Short")
plotshape(debugFMWShapeS, text="FMW", style=shape.labeldown, location=location.top, color=color.new(color.red, 70), textcolor=color.white, size=size.small, title="Debug FMW Short")

plotshape(debugEMAShapeL, text="EMA", style=shape.labelup, location=location.bottom, color=color.new(color.green, 70), textcolor=color.white, size=size.small, title="Debug EMA Long")
plotshape(debugADXShapeL, text="ADX", style=shape.labelup, location=location.bottom, color=color.new(color.green, 70), textcolor=color.white, size=size.small, title="Debug ADX Long")
plotshape(debugATRShapeL, text="ATR", style=shape.labelup, location=location.bottom, color=color.new(color.green, 70), textcolor=color.white, size=size.small, title="Debug ATR Long")
plotshape(debugFMWShapeL, text="FMW", style=shape.labelup, location=location.bottom, color=color.new(color.green, 70), textcolor=color.white, size=size.small, title="Debug FMW Long")

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ’Ğ˜Ğ—Ğ£ĞĞ› Â· Ğ›Ğ˜ĞĞ˜Ğ¯ ĞœĞĞœĞ•ĞĞ¢Ğ£ĞœĞ
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
plot(showFastWave ? fastWave : na, "Fast Momentum", color=color.aqua, linewidth=2)
hline(0, "Ğ‘Ğ°Ğ·Ğ°", color=color.white)

//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Ğ¢ĞĞ‘Ğ›Ğ Â· Ğ Ğ•ĞĞ›-Ğ¢ĞĞ™Ğœ ĞŸĞĞĞ•Ğ›Ğ¬
//â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var table rtPanel = table.new(position.top_right, 1, 3, bgcolor=color.new(color.black, 70))

var string cell0_text = ""
var string cell1_text = ""
var string cell2_text = ""
var color  cell2_color = color.white
var color  cell2_textcolor = color.white

if barstate.islast and not na(normalSize)  // âŒ ĞÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾: normalSize
    // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹
    impulsePct = safeNormalSize * impulseMult  // âœ… safeNormalSize Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ²
    movePct = (close - open) / open * 100

    isLongMove = movePct >= 0
    sign = isLongMove ? "+" : "âˆ’"

    remainPct = math.max(impulsePct - math.abs(movePct), 0)

    // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ÑÑ‡ĞµĞµĞº
    cell0_text := "ĞĞ¾Ñ€Ğ¼Ğ° ÑĞ²ĞµÑ‡Ğ¸:\n" + str.tostring(safeNormalSize, "#.###") + "%"
    cell1_text := "Ğ˜Ğ¼Ğ¿ÑƒĞ»ÑŒÑ ÑĞ²ĞµÑ‡Ğ¸:\n" + str.tostring(impulsePct, "#.###") + "%"

    // â”€â”€â”€â”€â”€ Ğ›ĞĞ“Ğ˜ĞšĞ Ğ¢Ğ Ğ•Ğ¢Ğ¬Ğ•Ğ™ Ğ¯Ğ§Ğ•Ğ™ĞšĞ˜ â”€â”€â”€â”€â”€
    if impulseDetectMode == "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ"
        // Ğ ĞµĞ¶Ğ¸Ğ¼ "ĞŸĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ": Ğ²ÑĞµĞ³Ğ´Ğ° "Ğ¶Ğ´Ñ‘Ğ¼ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ"
        cell2_text := "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:\nĞ¶Ğ´Ñ‘Ğ¼ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ ÑĞ²ĞµÑ‡Ğ¸"
        cell2_color := color.new(color.gray, 0)
        cell2_textcolor := color.white

    else if impulseDetectMode == "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ"
        // Ğ ĞµĞ¶Ğ¸Ğ¼ "ĞŸĞ¾ Ñ†ĞµĞ½Ğµ": Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ½Ğ° Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸
        if not filtersAllowedFixed
            cell2_text := "ĞĞµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ (" + filterBlockReasonFixed + ")"
            cell2_color := color.new(color.red, 0)
            cell2_textcolor := color.white
        else if impulseTouched
            // ĞŸĞ¾ÑĞ»Ğµ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ â€” Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµĞ¼ "0%" Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ½Ğ¾Ğ¹
            actualTouchPrice = impulseDirection == 1 ? priceUp : priceDown
            cell2_text := "0%\n(" + str.tostring(actualTouchPrice, format.mintick) + ")"
            cell2_color := color.new(#d4af37, 0)  // Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹
            cell2_textcolor := color.black
        else
            // Ğ”Ğ¾ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ñ Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¹ Ñ†ĞµĞ½Ğ¾Ğ¹
            targetPrice = isLongMove ? priceUp : priceDown
            cell2_text := "Ğ”Ğ¾ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°:\n" + sign + str.tostring(remainPct, "#.###") + "% (" + str.tostring(targetPrice, format.mintick) + ")"
            cell2_color := isLongMove ? color.new(color.lime, 0) : color.new(color.red, 0)
            cell2_textcolor := color.white

    else if impulseDetectMode == "LIVE"
        // Ğ ĞµĞ¶Ğ¸Ğ¼ LIVE: Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ
        if not impulseTouched
            // Ğ”Ğ¾ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ”Ğ˜ĞĞĞœĞ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ñ‚Ğ¸ĞºĞµ
            longAllowedNow = f_trendAllowedLong(emaLong, adxTrend, atrTrend)
            shortAllowedNow = f_trendAllowedShort(emaShort, adxTrend, atrTrend)

            momentumOKLong = f_momentumConfirmsLong(fastWave, fastWaveRising, fastWaveAllowed)
            momentumOKShort = f_momentumConfirmsShort(fastWave, fastWaveFalling, fastWaveAllowed)

            if not longAllowedNow and not shortAllowedNow
                // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ğ°ÑÑ‚ Ğ²Ñ…Ğ¾Ğ´
                reason = ""
                if useEMA200 and not emaLong and not emaShort
                    reason := "EMA"
                else if useADX and not adxTrend
                    reason := "ADX"
                else if useATRRegime and not atrTrend
                    reason := "ATR"
                else if impulseMode != "EASY" and not fastWaveAllowed
                    reason := "FMW"

                cell2_text := "ĞĞµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ (" + reason + ")"
                cell2_color := color.new(color.red, 0)
                cell2_textcolor := color.white
            else
                // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ°ÑÑ‚ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ñ Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¹ Ñ†ĞµĞ½Ğ¾Ğ¹
                targetPrice = isLongMove ? priceUp : priceDown
                cell2_text := "Ğ”Ğ¾ Ğ¸Ğ¼Ğ¿ÑƒĞ»ÑŒÑĞ°:\n" + sign + str.tostring(remainPct, "#.###") + "% (" + str.tostring(targetPrice, format.mintick) + ")"
                cell2_color := isLongMove ? color.new(color.lime, 0) : color.new(color.red, 0)
                cell2_textcolor := color.white
        else
            // ĞŸĞ¾ÑĞ»Ğµ ĞºĞ°ÑĞ°Ğ½Ğ¸Ñ â€” Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµĞ¼ "0%" Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ†ĞµĞ½Ğ¾Ğ¹
            actualTouchPrice = impulseDirection == 1 ? priceUp : priceDown
            cell2_text := "0%\n(" + str.tostring(actualTouchPrice, format.mintick) + ")"
            cell2_color := color.new(#d4af37, 0)  // Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹
            cell2_textcolor := color.black

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡ĞµĞ¹ĞºĞ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
    table.cell(rtPanel, 0, 0, cell0_text, text_color=color.white, bgcolor=color.new(color.black, 70))
    table.cell(rtPanel, 0, 1, cell1_text, text_color=color.white, bgcolor=color.new(color.black, 70))
    table.cell(rtPanel, 0, 2, cell2_text, text_color=cell2_textcolor, bgcolor=cell2_color)
